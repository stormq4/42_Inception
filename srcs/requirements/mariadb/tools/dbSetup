#!bin/bash

set -x

sed -i "s/bind-address.*/bind-address = $DB_HOST/" /etc/mysql/mariadb.conf.d/50-server.cnf

mysql_install_db --user=mysql --datadir=/var/lib.mysql

{
	echo "CREATE DATABASE IF NOT EXISTS $DB_NAME;
	CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PW';
	GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
	ALTER USER 'root'@'localhost' IDENTIFIED BY '$ROOT_PW';
	FLUSH PRIVILEGES;"
} | myslqld --bootstrap

exec "$@"

# echo  > /tmp/dbSetup.sql \
# "CREATE DATABASE IF NOT EXISTS $DB_NAME;
# CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PW';
# GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%';
# ALTER USER 'root'@'localhost' IDENTIFIED BY '$ROOT_PW';
# FLUSH PRIVILEGES;"

# echo "------testing sql file----"
# cat /tmp/dbSetup.sql
# echo "----done---"

# # sed -i "s|skip-networking|# skip-networking|g" /etc/mysql/mariadb.conf.d/50-server.cnf
# # sed -i "s|.*bind-address\s*=.*|bind-address=0.0.0.0|g" /etc/mysql/mariadb.conf.d/50-server.cnf

# echo "starting deamon"
# /usr/sbin/mysqld --user=mysql --skip-networking --default-time-zone=SYSTEM --wsrep_on=OFF \
# 		--expire-logs-days=0 \
# 		--loose-innodb_buffer_pool_load_at_startup=0 > /dev/null &
# MDB_PID=$!

# # sleep 10

# echo "this is PID: $MDB_PID"



# mysql < /tmp/dbSetup.sql > /dev/null

# # echo "stopping deamon"

# kill $MDB_PID
# wait $MDB_PID
# echo "start sql"

# mysqld --user=mysql --bootstrap < /tmp/dbSetup.sql > /dev/null
# exec /usr/sbin/mysqld --user=mysql > /dev/null