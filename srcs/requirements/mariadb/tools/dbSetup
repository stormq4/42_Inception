#!bin/bash

if [ ! -d /run/myslqd ]
then
	mkdir -p /var/run/mysqld
	chown -R mysql:mysql /var/run/mysqld
	chown -R mysql:mysql /var/lib/mysql

	mysql_install_db --basedir=/usr --datadir=/var/lib/mysql

	service mysql stop

	echo "test 2"

# cat > /tmp/dbSetup.sql << STOP
# USE mysql;
# FLUSH PRIVILEGES;
# CREATE DATABASE IF NOT EXISTS WORDPRESS;
# CREATE USER IF NOT EXISTS '$WP_USER'@'%' IDENTIFIED BY '$WP_PASSWORD';
# CREATE USER IF NOT EXISTS '$WP_ADMIN_USER'@'%' IDENTIFIED BY '$WP_ADMIN_PASSWORD';
# GRANT ALL PRIVILEGES ON *.* TO '$WP_ADMIN_USER'@'%' WITH GRANT OPTION;
# DELETE FROM mysql.user WHERE User='root';
# STOP

cat > /tmp/dbSetup.sql << STOP
USE mysql;
FLUSH PRIVILEGES;

DELETE FROM mysql.user WHERE User='';
DROP DATABASE test;
DELETE FROM mysql.db WHERE Db='test';

ALTER USER 'root'@'localhost' IDENTIFIED BY '$ROOT_PW';

CREATE DATABASE IF NOT EXISTS $WP_DB_NAME;

CREATE USER '$WP_ADMIN_USER'@'%';
SET PASSWORD FOR '$WP_ADMIN_USER'@'%' = PASSWORD('$WP_ADMIN_PASSWORD');
GRANT ALL PRIVILEGES ON wordpress.* TO '$WP_ADMIN_USER'@'%';
GRANT ALL ON wordpress.* to '$WP_ADMIN_USER'@'%';
FLUSH PRIVILEGES;

CREATE USER '$WP_USER'@'%';
SET PASSWORD FOR '$WP_PASSWORD'@'%' = PASSWORD('$WP_PASSWORD');
STOP

	echo "test 1"


	mysqld --user=mysql --bootstrap < /tmp/dbSetup.sql

fi
# service mysql start && mysql < /tmp/dbSetup.sql

# mysqladmin -u$WP_ADMIN_USER -p$WP_ADMIN_PASSWORD
# # mysqladmin -u$WP_ADMIN_USER -p$WP_ADMIN_PASSWORD shutdown
# # rm -f /tmp/wpdbscript.sql

# mysqld
# mysqladmin -h${MDB_NAME} -u${WP_USER} -p${WP_PASSWORD} shutdown
exec mysqld --user=mysql --console